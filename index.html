<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Карта параметров моря</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- библиотеки -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #menu { 
            position: absolute; background: #fff; padding: 10px; top: 10px; left: 10px; 
            border-radius: 4px; z-index: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); max-width: 220px;
        }
        #menu h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .layer-group button { 
            display: block; width: 100%; margin-bottom: 5px; border: 1px solid #ccc; background: #f9f9f9; 
            padding: 8px; cursor: pointer; text-align: left; 
        }
        .layer-group button:hover { background: #eee; }
        .layer-group button.active { background: #3887be; color: white; border-color: #3887be; }
        .controls { margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
        .controls fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 5px 5px 0 5px; margin-bottom: 10px; }
        .controls legend { font-size: 12px; font-weight: bold; padding: 0 5px; }
        .controls label { font-size: 14px; }
        #legend { 
            position: absolute; background: rgba(255, 255, 255, 0.9); padding: 10px; bottom: 30px; 
            right: 10px; border-radius: 4px; z-index: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        }
        .legend-key { display: inline-block; width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; }
        #legend h4 { margin: 0 0 10px 0; font-size: 14px; }
        #legend div { margin-bottom: 5px; font-size: 12px; }
        .mapboxgl-popup-content { font-size: 14px; padding: 10px; max-width: 250px; }
        .mapboxgl-popup-content strong { color: #3887be; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="menu">
    <fieldset>
        <legend>Горизонт</legend>
        <input type="radio" id="horizon-surface" name="horizon" value="0" checked>
        <label for="horizon-surface">Поверхность (0)</label><br>
        <input type="radio" id="horizon-bottom" name="horizon" value="дно">
        <label for="horizon-bottom">Дно</label>
    </fieldset>
    
    <h4>Параметры</h4>
    <div class="layer-group">
        <button id="btn-oxygen-points" class="active" data-param="oxygen">Кислород</button>
        <button id="btn-ph-points" data-param="ph">pH</button>
        <button id="btn-temp-points" data-param="temp">Температура</button>
        <button id="btn-salinity-points" data-param="salinity">Солёность</button>
    </div>

    <div class="controls">
        <input type="checkbox" id="show-labels">
        <label for="show-labels">Показывать подписи</label>
    </div>
</div>

<div id="legend"></div>

<script>
    const csvData = `station_id,bay,horizon,depth_m,temp_c,salinity_psu,oxygen_mgl,ph,latitude,longitude,time,date
02,Амурский залив,0,1.8,15.4,22.03,9.8,8.37,43.2347,131.8175,16:54:01,5/21/2025
02,Амурский залив,дно,9.3,6.2,33.02,9.2,8.30,43.2347,131.8175,16:54:01,5/21/2025
03,Амурский залив,0,2.2,14.2,24.87,9.5,8.38,43.2347,131.8836,6:22:29,5/21/2025
03,Амурский залив,дно,8.3,8.2,32.81,9.9,8.33,43.2347,131.8836,6:22:29,5/21/2025
06,Уссурийский залив,0,2.0,14.6,30.50,8.9,8.34,43.24167,132.27917,17:02:19,5/26/2025
06,Уссурийский залив,дно,11.9,9.4,32.85,9.4,8.37,43.24167,132.27917,17:02:19,5/26/2025
08,Амурский залив,0,2.1,14.3,26.59,8.9,8.18,43.2,131.78333,17:30:37,5/21/2025
08,Амурский залив,дно,15.5,5.2,33.30,8.1,8.18,43.2,131.78333,17:30:37,5/21/2025
10,Амурский залив,0,1.8,13.1,27.87,9.4,8.23,43.18333,131.88333,15:21:50,5/21/2025
10,Амурский залив,дно,12.1,8.1,32.65,9.6,8.31,43.18333,131.88333,15:21:50,5/21/2025
11,Уссурийский залив,0,2.6,12.0,32.06,9.4,8.34,43.2,132.17917,15:37:30,5/26/2025
11,Уссурийский залив,дно,12.0,8.5,32.97,9.4,8.33,43.2,132.17917,15:37:30,5/26/2025
12,Уссурийский залив,0,2.4,13.5,31.78,9.3,8.35,43.2,132.245,14:51:47,5/26/2025
12,Уссурийский залив,10,10.9,11.2,32.42,9.8,8.35,43.2,132.245,14:51:47,5/26/2025
12,Уссурийский залив,дно,22.5,6.2,33.32,9.9,8.35,43.2,132.245,14:51:47,5/26/2025
13,Уссурийский залив,0,2.0,14.1,31.42,9.1,8.33,43.2,132.3167,14:12:30,5/26/2025
13,Уссурийский залив,дно,12.8,8.7,33.01,9.5,8.38,43.2,132.3167,14:12:30,5/26/2025
14,Амурский залив,0,1.8,12.8,28.72,9,8.22,43.15333,131.77333,18:06:13,5/21/2025
14,Амурский залив,дно,11.3,8.5,31.77,9.1,8.29,43.15333,131.77333,18:06:13,5/21/2025
17,Уссурийский залив,0,2.3,11.9,31.93,9.4,8.26,43.15333,132.07667,10:40:21,5/26/2025
17,Уссурийский залив,дно,17.8,7.0,33.25,8.9,8.26,43.15333,132.07667,10:40:21,5/26/2025
20,Уссурийский залив,0,2.2,13.5,31.65,9.3,8.39,43.15333,132.24,12:32:42,5/26/2025
20,Уссурийский залив,10,10.7,8.9,32.96,10.2,8.33,43.15333,132.24,12:32:42,5/26/2025
20,Уссурийский залив,дно,30.6,5.5,33.42,8.3,8.23,43.15333,132.24,12:32:42,5/26/2025
23,Амурский залив,0,1.9,13.8,29.08,9.6,8.16,43.12,131.70333,19:25:50,5/21/2025
23,Амурский залив,дно,10.6,6.6,32.92,9.1,8.38,43.12,131.70333,19:25:50,5/21/2025
27,Уссурийский залив,0,2.3,10.8,32.55,9.6,8.25,43.10833,132.025,9:50:27,5/26/2025
27,Уссурийский залив,дно,18.0,6.6,33.29,9.1,8.26,43.10833,132.025,9:50:27,5/26/2025
29,Уссурийский залив,0,2.2,12.5,32.11,9.2,8.29,43.11333,132.18333,8:17:12,5/26/2025
29,Уссурийский залив,10,9.7,9.9,33.02,9.6,8.31,43.11333,132.18333,8:17:12,5/26/2025
29,Уссурийский залив,дно,41.2,4.2,33.54,8.3,8.22,43.11333,132.18333,8:17:12,5/26/2025
31,Уссурийский залив,0,2.2,13.4,31.30,9,8.29,43.101388888889,132.3,6:55:08,5/26/2025
31,Уссурийский залив,10,10.7,9.6,32.89,10.3,8.34,43.101388888889,132.3,6:55:08,5/26/2025
31,Уссурийский залив,дно,20.9,7.2,33.23,9,8.27,43.101388888889,132.3,6:55:08,5/26/2025
32,Амурский залив,0,1.6,13.2,30.04,9.3,8.28,43.083611111111,131.65666666667,20:34:05,5/21/2025
32,Амурский залив,дно,10.9,8.9,32.64,9.9,8.41,43.083611111111,131.65666666667,20:34:05,5/21/2025
33,Амурский залив,0,1.6,12.9,30.06,7.4,8.28,43.08333,131.735,20:04:43,5/21/2025
33,Амурский залив,дно,19.4,6.8,33.32,9.4,8.25,43.08333,131.735,20:04:43,5/21/2025
37,Амурский залив,0,1.6,12.3,30.71,8.9,8.33,43.05833,131.65,21:34:24,5/21/2025
37,Амурский залив,10,9.4,7.3,32.92,9.4,8.30,43.05833,131.65,21:34:24,5/21/2025
37,Амурский залив,дно,16.9,6.4,33.26,9.2,8.27,43.05833,131.65,21:34:24,5/21/2025
42,Уссурийский залив,0,1.6,10.5,32.95,9.3,8.28,43.05833,132.09167,3:59:12,5/26/2025
42,Уссурийский залив,10,10.3,8.6,33.04,9.9,8.32,43.05833,132.09167,3:59:12,5/26/2025
42,Уссурийский залив,дно,47.5,3.6,33.62,7.4,8.16,43.05833,132.09167,3:59:12,5/26/2025
44,Уссурийский залив,0,2.1,11.8,32.44,9.4,8.30,43.05833,132.225,5:21:50,5/26/2025
44,Уссурийский залив,10,11.1,9.2,33.01,10.1,8.32,43.05833,132.225,5:21:50,5/26/2025
44,Уссурийский залив,дно,26.1,7.1,33.25,10,8.35,43.05833,132.225,5:21:50,5/26/2025
47,Амурский залив,0,1.3,12.2,29.8724,9.4,8.30,43.025,131.589,14:51:33,5/21/2025
47,Амурский залив,10,10.9,7.8,33.1852,9.6,8.29,43.025,131.589,14:51:33,5/21/2025
47,Амурский залив,дно,16.5,6.7,33.3477 ,9.7,8.32,43.025,131.589,14:51:33,5/21/2025
49,Амурский залив,0,1.5,12.1,31.27,9.2,8.29,43.025,131.70133,23:55:30,5/21/2025
49,Амурский залив,10,10.3,9.1,33.12,9.7,8.30,43.025,131.70133,23:55:30,5/21/2025
49,Амурский залив,дно,22.8,7.0,33.31,9.7,8.31,43.025,131.70133,23:55:30,5/21/2025
51,Уссурийский залив,0,2.1,13.3,31.37,9.2,8.31,43.00833,131.95,11:40:58,5/23/2025
51,Уссурийский залив,дно,28.5,5.0,33.45,8.6,8.27,43.00833,131.95,11:40:58,5/23/2025
53,Амурский залив,0,1.6,11.9,31.41,9.1,8.31,42.99,131.63,2:15:04,5/22/2025
53,Амурский залив,10,10.6,8.5,33.16,9.7,8.32,42.99,131.63,2:15:04,5/22/2025
53,Уссурийский залив,дно,32.5,5.3,33.44,9.5,8.24,42.99,131.63,2:15:04,5/22/2025
56,Уссурийский залив,0,2.0,11.5,32.43,9.9,8.31,42.98333,132,12:48:30,5/23/2025
56,Уссурийский залив,10,10.9,8.7,32.96,9.6,8.33,42.98333,132,12:48:30,5/23/2025
56,Уссурийский залив,дно,48.0,3.6,33.64,9.4,8.29,42.98333,132,12:48:30,5/23/2025
58,Уссурийский залив,0,1.8,11.0,32.95,9.6,8.29,42.99,132.20417,2:27:48,5/26/2025
58,Уссурийский залив,10,10.0,10.6,32.96,9.2,8.30,42.99,132.20417,2:27:48,5/26/2025
58,Уссурийский залив,дно,31.0,6.8,33.26,8.8,8.27,42.99,132.20417,2:27:48,5/26/2025
59,Уссурийский залив,0,2.1,13.0,32.13,9.7,8.29,43.01333,132.30667,1:46:40,5/26/2025
59,Уссурийский залив,10,10.3,10.2,32.93,9.1,8.28,43.01333,132.30667,1:46:40,5/26/2025
59,Уссурийский залив,дно,22.7,4.7,33.45,8.6,8.28,43.01333,132.30667,1:46:40,5/26/2025
61,Амурский залив,0,1.9,11.7,31.59,9.1,8.31,42.959,131.58133,4:16:54,5/22/2025
61,Амурский залив,10,10.0,7.6,33.25,9.9,8.32,42.959,131.58133,4:16:54,5/22/2025
61,Амурский залив,дно,33.4,4.9,33.34,9,8.26,42.959,131.58133,4:16:54,5/22/2025
63,Амурский залив,0,1.8,9.6,32.93,9.6,8.30,42.95833,131.68,3:15:35,5/22/2025
63,Амурский залив,10,10.5,8.1,33.21,10,8.31,42.95833,131.68,3:15:35,5/22/2025
63,Амурский залив,дно,27.4,5.3,33.49,9.5,8.30,42.95833,131.68,3:15:35,5/22/2025
67,Уссурийский залив,0,1.9,11.2,32.37,9.6,8.32,42.92333,131.83333,9:55:29,5/23/2025
67,Уссурийский залив,дно,43.0,4.2,33.51,9.6,8.30,42.92333,131.83333,9:55:29,5/23/2025
68,Уссурийский залив,0,2.2,9.4,33.00,9.8,8.31,42.93333,131.94333,10:50:15,5/23/2025
68,Уссурийский залив,10,9.7,8.5,33.01,9.8,8.33,42.93333,131.94333,10:50:15,5/23/2025
68,Уссурийский залив,дно,57.3,3.2,33.67,9.1,8.26,42.93333,131.94333,10:50:15,5/23/2025
69,Уссурийский залив,0,2.4,10.3,33.01,9.5,8.30,42.92333,132.06333,13:36:03,5/23/2025
69,Уссурийский залив,10,10.2,8.8,33.07,10.1,8.33,42.92333,132.06333,13:36:03,5/23/2025
69,Уссурийский залив,дно,46.8,3.2,33.61,9.4,8.28,42.92333,132.06333,13:36:03,5/23/2025
70,Уссурийский залив,0,2.1,11.5,32.78,9.7,8.27,42.88667,132.2,0:14:05,5/26/2025
70,Уссурийский залив,10,9.9,10.4,32.96,9.9,8.30,42.88667,132.2,0:14:05,5/26/2025
70,Уссурийский залив,дно,53.3,3.0,33.63,9.3,8.25,42.88667,132.2,0:14:05,5/26/2025
73,Открытая часть залива Петра Великого,0,2.0,11.0,32.43,9.7,8.31,42.90167,131.775,8:48:01,5/23/2025
73,Открытая часть залива Петра Великого,дно,39.4,4.5,33.47,9.6,8.30,42.90167,131.775,8:48:01,5/23/2025
78,Открытая часть залива Петра Великого,0,2.1,9.1,32.97,9.6,8.31,42.84333,131.535,7:57:54,5/22/2025
78,Открытая часть залива Петра Великого,дно,48.3,4.5,33.60,9.2,8.27,42.84333,131.535,7:57:54,5/22/2025
80,Открытая часть залива Петра Великого,0,2.1,9.9,33.10,9.8,8.27,42.84333,131.74167,6:16:00,5/24/2025
80,Открытая часть залива Петра Великого,дно,55.4,3.6,33.62,9.7,8.27,42.84333,131.74167,6:16:00,5/24/2025
81,Открытая часть залива Петра Великого,0,2.3,8.2,33.11,9.8,8.32,42.84333,131.855,7:55:47,5/23/2025
81,Открытая часть залива Петра Великого,дно,58.3,2.7,33.70,9.2,8.27,42.84333,131.855,7:55:47,5/23/2025
84,Открытая часть залива Петра Великого,0,2.1,9.9,32.93,9.6,8.28,42.84333,132.19833,9:25:51,5/24/2025
84,Открытая часть залива Петра Великого,дно,68.1,2.7,33.68,9.7,8.25,42.84333,132.19833,9:25:51,5/24/2025
86,Открытая часть залива Петра Великого,0,1.9,9.8,33.03,9.6,8.28,42.815,132.31,12:22:22,5/24/2025
86,Открытая часть залива Петра Великого,дно,60.6,2.6,33.70,9.3,8.25,42.815,132.31,12:22:22,5/24/2025
88,Открытая часть залива Петра Великого,0,2.2,10.0,32.92,9.8,8.29,42.7625,132.30583,11:28:28,5/24/2025
88,Открытая часть залива Петра Великого,дно,67.6,2.2,33.86,9,8.24,42.7625,132.30583,11:28:28,5/24/2025
89,Открытая часть залива Петра Великого,0,1.6,10.7,33.00,9.4,8.27,42.4,131.2,19:13:29,5/22/2025
89,Открытая часть залива Петра Великого,дно,100.1,2.1,33.98,9.5,8.26,42.4,131.2,19:13:29,5/22/2025
91,Открытая часть залива Петра Великого,0,1.7,10.3,33.07,9.5,8.27,42.5,131.2,7:20:19,5/23/2025
91,Открытая часть залива Петра Великого,дно,59.6,3.2,33.70,9.5,8.26,42.5,131.2,7:20:19,5/23/2025
94,Открытая часть залива Петра Великого,0,1.7,11.4,32.96,9.6,8.27,42.45,131.4,21:23:18,5/22/2025
94,Открытая часть залива Петра Великого,дно,81.7,1.9,33.99,9.6,8.24,42.45,131.4,21:23:18,5/22/2025
96,Открытая часть залива Петра Великого,0,1.8,11.7,32.98,9.3,8.27,42.55,131.4,16:18:01,5/22/2025
96,Открытая часть залива Петра Великого,дно,70.7,2.1,33.78,9.5,8.25,42.55,131.4,16:18:01,5/22/2025
99,Открытая часть залива Петра Великого,0,1.7,4.7,32.54,9.7,8.37,42.7,131.4,10:52:42,5/22/2025
99,Открытая часть залива Петра Великого,дно,25.8,10.5,33.53,9.5,8.21,42.7,131.4,10:52:42,5/22/2025
101,Открытая часть залива Петра Великого,0,1.9,10.9,32.30,9.3,8.29,42.8,131.4,9:33:58,5/22/2025
101,Открытая часть залива Петра Великого,дно,22.0,5.5,33.46,9.9,8.31,42.8,131.4,9:33:58,5/22/2025
102,Открытая часть залива Петра Великого,0,2.1,9.6,33.27,9.8,8.30,42.4,131.6,0:45:47,5/23/2025
102,Открытая часть залива Петра Великого,дно,201.1,1.9,34.03,9.2,8.25,42.4,131.6,0:45:47,5/23/2025
104,Открытая часть залива Петра Великого,0,1.7,11.0,33.69,9.4,8.30,42.5,131.6,23:26:07,5/22/2025
104,Открытая часть залива Петра Великого,дно,87.2,2.4,33.99,9.3,8.27,42.5,131.6,23:26:07,5/22/2025
106,Открытая часть залива Петра Великого,0,2.5,10.2,33.36,9.6,8.29,42.6,131.6,14:18:41,5/22/2025
106,Открытая часть залива Петра Великого,дно,78.9,2.2,33.83,9.8,8.26,42.6,131.6,14:18:41,5/22/2025
108,Открытая часть залива Петра Великого,0,1.8,10.1,33.06,9.8,8.29,42.7,131.6,12:58:39,5/22/2025
108,Открытая часть залива Петра Великого,дно,67.1,2.4,33.72,9.5,8.25,42.7,131.6,12:58:39,5/22/2025
112,Открытая часть залива Петра Великого,0,1.5,8.6,33.33,10,8.32,42.45,131.8,2:55:36,5/23/2025
112,Открытая часть залива Петра Великого,дно,213.9,1.9,34.03,9.1,8.27,42.45,131.8,2:55:36,5/23/2025
114,Открытая часть залива Петра Великого,0,1.7,10.2,33.72,9.7,8.32,42.55,131.8,4:08:16,5/23/2025
114,Открытая часть залива Петра Великого,дно,86.3,2.7,33.99,9.6,8.30,42.55,131.8,4:08:16,5/23/2025
116,Открытая часть залива Петра Великого,0,2.2,9.4,33.23,9.9,8.31,42.65,131.8,5:20:45,5/23/2025
116,Открытая часть залива Петра Великого,дно,67.2,2.4,33.74,9.7,8.29,42.65,131.8,5:20:45,5/23/2025
118,Открытая часть залива Петра Великого,0,2.1,9.1,33.27,9.8,8.31,42.75,131.8,6:38:50,5/23/2025
118,Открытая часть залива Петра Великого,дно,65.7,2.4,33.71,9.2,8.27,42.75,131.8,6:38:50,5/23/2025
120,Открытая часть залива Петра Великого,0,1.9,9.7,33.31,9.9,8.28,42.4,132,0:04:14,5/24/2025
120,Открытая часть залива Петра Великого,дно,209.1,1.8,34.04,8.9,8.23,42.4,132,0:04:14,5/24/2025
122,Открытая часть залива Петра Великого,0,1.8,9.7,33.37,10,8.30,42.5,132,1:14:29,5/24/2025
122,Открытая часть залива Петра Великого,10,10.4,7.6,33.42,10.6,8.33,42.5,132,1:14:29,5/24/2025
122,Открытая часть залива Петра Великого,дно,94.5,2.8,33.86,10,8.29,42.5,132,1:14:29,5/24/2025
124,Открытая часть залива Петра Великого,0,1.9,9.0,33.29,10.1,8.30,42.6,132,2:16:56,5/24/2025
124,Открытая часть залива Петра Великого,10,10.0,8.1,33.31,10.3,8.33,42.6,132,2:16:56,5/24/2025
124,Открытая часть залива Петра Великого,дно,86.2,2.6,33.95,9.5,8.29,42.6,132,2:16:56,5/24/2025
126,Открытая часть залива Петра Великого,0,1.9,10.1,33.42,9.9,8.29,42.7,132,17:18:01,5/23/2025
126,Открытая часть залива Петра Великого,дно,67.2,2.4,33.69,9.5,8.28,42.7,132,17:18:01,5/23/2025
128,Открытая часть залива Петра Великого,0,2.0,9.1,33.17,10.3,8.28,42.8,132,15:57:10,5/23/2025
128,Открытая часть залива Петра Великого,дно,71.3,2.5,33.68,9.4,8.25,42.8,132,15:57:10,5/23/2025
130,Открытая часть залива Петра Великого,0,2.0,9.7,33.09,9.9,8.24,42.45,132.2,22:12:35,5/23/2025
130,Открытая часть залива Петра Великого,10,9.4,7.3,33.39,10.2,8.31,42.45,132.2,22:12:35,5/23/2025
130,Открытая часть залива Петра Великого,дно,121.2,2.2,34.03,9.3,8.25,42.45,132.2,22:12:35,5/23/2025
132,Открытая часть залива Петра Великого,0,1.7,10.1,32.89,9.6,8.28,42.55,132.2,21:03:11,5/23/2025
132,Открытая часть залива Петра Великого,10,9.2,8.3,33.07,10.3,8.32,42.55,132.2,21:03:11,5/23/2025
132,Открытая часть залива Петра Великого,дно,81.8,2.4,33.98,9.3,8.25,42.55,132.2,21:03:11,5/23/2025
134,Открытая часть залива Петра Великого,0,2.1,9.6,32.94,10,8.28,42.65,132.2,19:01:25,5/23/2025
134,Открытая часть залива Петра Великого,дно,76.7,2.5,33.99,9.3,8.25,42.65,132.2,19:01:25,5/23/2025
136,Открытая часть залива Петра Великого,0,2.1,9.4,32.95,9.8,8.29,42.75,132.2,10:42:26,5/24/2025
136,Открытая часть,дно,72.1,2.1,33.90,9,8.24,42.75,132.2,10:42:26,5/24/2025
138,Открытая часть залива Петра Великого,0,2.3,9.4,33.67,9.7,8.31,42.4,132.4,22:19:06,5/24/2025
138,Открытая часть залива Петра Великого,дно,207.1,1.9,34.04,9.2,8.26,42.4,132.4,22:19:06,5/24/2025
140,Открытая часть залива Петра Великого,0,2.2,8.7,33.28,10.8,8.29,42.5,132.4,20:57:26,5/24/2025
140,Открытая часть залива Петра Великого,дно,103.9,2.2,34.02,9.6,8.26,42.5,132.4,20:57:26,5/24/2025
142,Открытая часть залива Петра Великого,0,1.1,8.3,33.44,10.3,8.27,42.6,132.4,19:41:21,5/24/2025
142,Открытая часть залива Петра Великого,дно,90.6,2.5,33.95,9.5,8.26,42.6,132.4,19:41:21,5/24/2025
144,Открытая часть залива Петра Великого,0,2.2,8.0,33.03,10.2,8.32,42.7,132.4,18:18:03,5/24/2025
144,Открытая часть залива Петра Великого,дно,73.1,2.2,33.89,9.4,8.27,42.7,132.4,18:18:03,5/24/2025
148,Открытая часть залива Петра Великого,0,2.1,8.8,33.19,9.9,8.30,42.45,132.6,0:24:00,5/25/2025
148,Открытая часть залива Петра Великого,дно,205.4,2.0,34.03,9.4,8.25,42.45,132.6,0:24:00,5/25/2025
150,Открытая часть залива Петра Великого,0,1.8,8.4,33.21,10,8.30,42.55,132.6,1:37:26,5/25/2025
150,Открытая часть залива Петра Великого,дно,111.2,2.5,33.97,9.4,8.26,42.55,132.6,1:37:26,5/25/2025
152,Открытая часть залива Петра Великого,0,2.0,8.8,33.27,10,8.33,42.65,132.6,2:47:49,5/25/2025
152,Открытая часть залива Петра Великого,дно,86.5,2.3,33.91,9.6,8.28,42.65,132.6,2:47:49,5/25/2025
154,Открытая часть залива Петра Великого,0,2.4,9.7,32.75,9.6,8.32,42.75,132.6,16:12:48,5/24/2025
154,Открытая часть залива Петра Великого,дно,58.7,2.4,33.80,9.8,8.29,42.75,132.6,16:12:48,5/24/2025
158,Открытая часть залива Петра Великого,0,1.6,8.8,32.68,9.6,8.29,42.5,132.8,8:13:37,5/25/2025
158,Открытая часть залива Петра Великого,дно,202.0,2.1,34.03,9.3,8.22,42.5,132.8,8:13:37,5/25/2025
160,Открытая часть залива Петра Великого,0,1.8,9.0,32.67,9.8,8.29,42.6,132.8,6:49:50,5/25/2025
160,Открытая часть залива Петра Великого,дно,102.7,2.3,33.93,9.4,8.24,42.6,132.8,6:49:50,5/25/2025
162,Открытая часть залива Петра Великого,0,2.3,8.5,32.89,9.9,8.31,42.7,132.8,5:30:50,5/25/2025
162,Открытая часть залива Петра Великого,дно,54.7,2.5,33.73,9.7,8.30,42.7,132.8,5:30:50,5/25/2025
164,Открытая часть залива Петра Великого,0,2.0,10.1,32.07,9.6,8.30,42.8,132.8,4:21:00,5/25/2025
164,Открытая часть залива Петра Великого,дно,21.6,5.3,33.40,9.8,8.32,42.8,132.8,4:21:00,5/25/2025
168,Открытая часть залива Петра Великого,0,1.8,8.5,33.39,9.8,8.30,42.55,133,11:03:30,5/25/2025
168,Открытая часть залива Петра Великого,дно,200.7,2.1,34.03,10.1,8.24,42.55,133,11:03:30,5/25/2025
170,Открытая часть залива Петра Великого,0,2.5,8.3,33.22,10.2,8.30,42.65,133,12:20:34,5/25/2025
170,Открытая часть залива Петра Великого,дно,82.9,2.4,33.89,9.5,8.27,42.65,133,12:20:34,5/25/2025
174,Открытая часть залива Петра Великого,0,1.6,8.9,33.29,9.7,8.31,42.5,133.2,17:01:15,5/25/2025
174,Открытая часть залива Петра Великого,дно,207.3,1.8,34.03,9.1,8.24,42.5,133.2,17:01:15,5/25/2025
176,Открытая часть залива Петра Великого,0,1.9,8.7,33.39,9.7,8.31,42.6,133.2,15:35:08,5/25/2025
176,Открытая часть залива Петра Великого,дно,127.6,2.3,34.00,9.6,8.26,42.6,133.2,15:35:08,5/25/2025
178,Открытая часть залива Петра Великого,0,2.7,8.4,33.18,10.2,8.30,42.7,133.2,14:21:19,5/25/2025
178,Открытая часть залива Петра Великого,дно,53.3,2.9,33.81,9.9,8.28,42.7,133.2,14:21:19,5/25/2025`;

    mapboxgl.accessToken = 'pk.eyJ1IjoiYm9sZWc5MzQiLCJhIjoiY2syY3pjeXFyMjN5aTNobzZmZGl5cng3aiJ9.ADhGQN0rFnGwPCk53capfQ';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10', 
        center: [132.026960, 43.130572],
        zoom: 8.95
    });
    
    // --- НАСТРОЙКИ ВИЗУАЛИЗАЦИИ ---
    const config = {
        scales: {
            oxygen:   { title: 'Кислород, мг/л', prop: 'oxygen_mgl', format: 1, bands: ['#ffffcc', '#c2e699', '#78c679', '#31a354', '#006837'], sizeConfig: { base: 12, stops: [18, 12], inverted: true } },
            ph:       { title: 'pH', prop: 'ph', format: 2, bands: ['#4575b4', '#ffffbf', '#d73027'], breaks: [8.15, 8.25, 8.35, 8.45], sizeConfig: { base: 14 } },
            temp:     { title: 'Температура, °C', prop: 'temp_c', format: 1, bands: ['#74add1', '#ffffbf', '#fdae61', '#d73027'], sizeConfig: { base: 12 } },
            salinity: { title: 'Солёность, PSU', prop: 'salinity_psu', format: 2, bands: ['#ffffd9','#7fcdbb','#2c7fb8'], sizeConfig: { base: 13, stops: [12, 20] } }
        },
        firstLabelLayerId: 'waterway-label'
    };
    
    let fullData = [];
    let state = {
        activeParam: 'oxygen',
        showLabels: false,
        horizon: '0'
    };

    // --- ФУНКЦИИ-ПОМОЩНИКИ ---
    function formatNumber(value, decimalPlaces) {
        if (typeof value !== 'number' || !isFinite(value)) return '';
        return value.toFixed(decimalPlaces).replace('.', ',');
    }

    function formatDateTime(dateStr, timeStr) {
        if (!dateStr || !timeStr) return 'Нет данных';
        const dateParts = dateStr.split('/');
        const timeParts = timeStr.split(':');
        if (dateParts.length !== 3 || timeParts.length < 2) return 'Неверный формат';
        const [month, day, year] = dateParts;
        const [hour, minute] = timeParts;
        return `${String(day).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year} ${hour}:${minute} (GMT+10)`;
    }

    function generateDynamicBreaks(data, prop, numSteps) {
        if (!data || data.length === 0) return [];
        const values = data.map(d => d.properties[prop]).filter(v => typeof v === 'number' && isFinite(v));
        if (values.length < 2) return values.length > 0 ? [values[0], values[0]] : [];
        const min = Math.min(...values);
        const max = Math.max(...values);
        if (min === max) return [min, max];
        const step = (max - min) / numSteps;
        return Array.from({length: numSteps + 1}, (_, i) => parseFloat((min + i * step).toFixed(2)));
    }

    function updateLegend() {
        const paramConfig = config.scales[state.activeParam];
        const dynamicBreaks = paramConfig.dynamicBreaks;
        if (!paramConfig || !dynamicBreaks || dynamicBreaks.length < 2) {
            document.getElementById('legend').innerHTML = ''; return;
        }
        let content = `<h4>${paramConfig.title}</h4>`;
        for (let i = 0; i < paramConfig.bands.length; i++) {
             if(dynamicBreaks[i+1]) {
                const start = formatNumber(dynamicBreaks[i], paramConfig.format);
                const end = formatNumber(dynamicBreaks[i+1], paramConfig.format);
                content += `<div><span class="legend-key" style="background-color: ${paramConfig.bands[i]}"></span>${start} - ${end}</div>`;
             }
        }
        document.getElementById('legend').innerHTML = content;
    }
    
    function updateLayers() {
        const filteredFeatures = fullData.filter(f => String(f.properties.horizon) === state.horizon);
        const filteredGeoJSON = { type: 'FeatureCollection', features: filteredFeatures };
        map.getSource('points-source').setData(filteredGeoJSON);

        Object.keys(config.scales).forEach(param => {
            const paramConfig = config.scales[param];
            const layerId = `${param}-points-layer`;
            
            const dynamicBreaks = paramConfig.breaks || generateDynamicBreaks(filteredFeatures, paramConfig.prop, paramConfig.bands.length);
            paramConfig.dynamicBreaks = dynamicBreaks;

            if (dynamicBreaks.length > 1) {
                const colorExpression = ['step', ['get', paramConfig.prop], '#ccc', ...dynamicBreaks.slice(0, -1).flatMap((b, i) => [b, paramConfig.bands[i]])];
                map.setPaintProperty(layerId, 'circle-color', colorExpression);

                if (paramConfig.sizeConfig.stops) {
                    const [r1, r2] = paramConfig.sizeConfig.stops;
                    const dataMin = dynamicBreaks[0];
                    const dataMax = dynamicBreaks[dynamicBreaks.length - 1];
                    const radiusStops = paramConfig.sizeConfig.inverted ? [dataMin, r1, dataMax, r2] : [dataMin, r2, dataMax, r1];
                    map.setPaintProperty(layerId, 'circle-radius', ['interpolate', ['linear'], ['get', paramConfig.prop], ...radiusStops]);
                } else {
                    map.setPaintProperty(layerId, 'circle-radius', paramConfig.sizeConfig.base);
                }
            } else {
                 map.setPaintProperty(layerId, 'circle-color', '#cccccc');
                 map.setPaintProperty(layerId, 'circle-radius', paramConfig.sizeConfig.base);
            }
        });
        
        Object.keys(config.scales).forEach(param => {
            const is_active = param === state.activeParam;
            map.setLayoutProperty(`${param}-points-layer`, 'visibility', is_active ? 'visible' : 'none');
            map.setLayoutProperty(`${param}-labels-layer`, 'visibility', is_active && state.showLabels ? 'visible' : 'none');
        });
        
        updateLegend();
    }

    map.on('load', () => {
        // Устанавливаем русский язык для карты ***
        map.setLanguage('ru');

        const parsed = Papa.parse(csvData, { header: true, dynamicTyping: true, skipEmptyLines: true });
        const validData = parsed.data.filter(p => p.longitude != null && p.latitude != null);
        
        validData.forEach(p => {
            p.datetime_formatted = formatDateTime(p.date, p.time);
            p.oxygen_mgl_formatted = formatNumber(p.oxygen_mgl, 1);
            p.temp_c_formatted = formatNumber(p.temp_c, 1);
            p.ph_formatted = formatNumber(p.ph, 2);
            p.salinity_psu_formatted = formatNumber(p.salinity_psu, 2);
        });

        fullData = validData.map(p => ({ type: 'Feature', geometry: { type: 'Point', coordinates: [p.longitude, p.latitude] }, properties: p }));
        
        map.addSource('points-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

        Object.entries(config.scales).forEach(([param, scale]) => {
            map.addLayer({ id: `${param}-points-layer`, type: 'circle', source: 'points-source', layout: { visibility: 'none' }, paint: { 'circle-stroke-width': 1.5, 'circle-stroke-color': '#fff' } }, config.firstLabelLayerId);
            map.addLayer({ id: `${param}-labels-layer`, type: 'symbol', source: 'points-source', layout: { visibility: 'none', 'text-field': ['get', `${scale.prop}_formatted`], 'text-size': 11, 'text-offset': [0, 0], 'text-allow-overlap': true, 'text-ignore-placement': true }, paint: { 'text-color': '#000000', 'text-halo-color': '#ffffff', 'text-halo-width': 2 } }, config.firstLabelLayerId);
        });
        
        document.querySelectorAll('.layer-group button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.layer-group button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                state.activeParam = e.target.dataset.param;
                updateLayers();
            });
        });
        
        document.querySelectorAll('input[name="horizon"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.horizon = e.target.value;
                updateLayers();
            });
        });
        
        document.getElementById('show-labels').addEventListener('change', (e) => {
            state.showLabels = e.target.checked;
            updateLayers();
        });

        Object.keys(config.scales).forEach(param => {
            map.on('click', `${param}-points-layer`, (e) => {
                const props = e.features[0].properties;
                new mapboxgl.Popup().setLngLat(e.lngLat)
                    .setHTML(`<strong>Станция ${props.station_id} (${props.horizon})</strong><br>
                             Дата: ${props.datetime_formatted}<br>
                             --------------------<br>
                             Температура: ${props.temp_c_formatted}°C<br>
                             Солёность: ${props.salinity_psu_formatted} PSU<br>
                             Кислород: ${props.oxygen_mgl_formatted} мг/л<br>
                             pH: ${props.ph_formatted}`)
                    .addTo(map);
            });
            map.on('mouseenter', `${param}-points-layer`, () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', `${param}-points-layer`, () => map.getCanvas().style.cursor = '');
        });

        updateLayers();
    });
</script>

</body>
</html>