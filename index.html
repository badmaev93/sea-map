<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Карта параметров моря</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #menu { 
            position: absolute; background: #fff; padding: 10px; top: 10px; left: 10px; 
            border-radius: 4px; z-index: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); max-width: 220px;
        }
        #menu h4 { margin: 15px 0 10px 0; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .layer-group button { 
            display: block; width: 100%; margin-bottom: 5px; border: 1px solid #ccc; background: #f9f9f9; 
            padding: 8px; cursor: pointer; text-align: left; 
        }
        .layer-group button:hover { background: #eee; }
        .layer-group button.active { background: #3887be; color: white; border-color: #3887be; }
        .controls { margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
        #menu fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 5px 5px 5px 5px; margin-bottom: 10px; }
        #menu fieldset legend { font-size: 12px; font-weight: bold; padding: 0 5px; }
        #menu label { font-size: 14px; }
        #year-select { width: 100%; padding: 5px; }
        #legend { 
            position: absolute; background: rgba(255, 255, 255, 0.9); padding: 10px; bottom: 50px;
            right: 10px; border-radius: 4px; z-index: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        }
        .legend-key { display: inline-block; width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; }
        #legend h4 { margin: 0 0 10px 0; font-size: 14px; }
        #legend div { margin-bottom: 5px; font-size: 12px; }
        .mapboxgl-popup-content { font-size: 14px; padding: 10px; max-width: 280px; }
        .mapboxgl-popup-content strong { color: #3887be; display: block; margin-bottom: 2px; }
        .mapboxgl-popup-content .popup-subheader { color: #555; font-size: 13px; }
        .mapboxgl-popup-content table { width: 100%; margin-top: 8px; border-collapse: collapse; }
        .mapboxgl-popup-content td { padding: 3px 0; }
        .mapboxgl-popup-content td:last-child { text-align: right; font-weight: bold; padding-left: 10px; }
        
        .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib {
            display: none !important;
        }

        #custom-logo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 2;
        }
        #custom-logo img {
            height: 80px; /* размер */
            width: auto;
        }

        #custom-attribution {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 2;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        #custom-attribution a {
            color: #333;
            text-decoration: none;
        }
        #custom-attribution a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="custom-logo">
    <img src="https://raw.githubusercontent.com/badmaev93/sea-map/refs/heads/main/150_logo75.png" alt="ДВНИГМИ">
</div>
<div id="custom-attribution">
    <a href="https://www.mapbox.com/about/maps/" target="_blank">© Mapbox</a> | 
    <a href="http://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap</a> | 
    <a href="https://www.mapbox.com/feedback/" target="_blank">Обратная связь по карте</a>
</div>


<div id="menu">
    <fieldset>
        <legend>Год</legend>
        <select id="year-select"></select>
    </fieldset>
    <h4>Параметры</h4>
    <div class="layer-group">
        <button id="btn-oxygen-points" class="active" data-param="oxygen">Кислород</button>
        <button id="btn-ph-points" data-param="ph">pH</button>
        <button id="btn-temp-points" data-param="temp">Температура</button>
        <button id="btn-salinity-points" data-param="salinity">Солёность</button>
    </div>
    <fieldset>
        <legend>Горизонт</legend>
        <input type="radio" id="horizon-surface" name="horizon" value="0" checked>
        <label for="horizon-surface">Поверхность (0)</label><br>
        <input type="radio" id="horizon-bottom" name="horizon" value="дно">
        <label for="horizon-bottom">Дно</label>
    </fieldset>
    <div class="controls">
        <input type="checkbox" id="show-labels">
        <label for="show-labels">Показывать подписи</label>
    </div>
</div>

<div id="legend"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYm9sZWc5MzQiLCJhIjoiY2syY3pjeXFyMjN5aTNobzZmZGl5cng3aiJ9.ADhGQN0rFnGwPCk53capfQ';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10', 
        center: [132.026960, 43.130572],
        zoom: 8.95,
        attributionControl: false 
    });
    
    const config = {
        scales: {
            oxygen:   { title: 'Кислород, мг/л', prop: 'oxygen_mgl', format: 1, breaks: [6, 8, 10], bands: ['#d73027', '#c2e699', '#78c679', '#31a354'], sizeConfig: { base: 12 } },
            ph:       { title: 'pH', prop: 'ph', format: 2, bands: ['#deebf7', '#9ecae1', '#3182bd'], sizeConfig: { base: 14 } },
            temp:     { title: 'Температура, °C', prop: 'temp_c', format: 1, bands: ['#74add1', '#ffffbf', '#fdae61', '#d73027'], sizeConfig: { base: 12 } },
            salinity: { title: 'Солёность, PSU', prop: 'salinity_psu', format: 2, bands: ['#ffffd9','#7fcdbb','#2c7fb8'], sizeConfig: { base: 13 } }
        },
        firstLabelLayerId: 'waterway-label'
    };
    
    let fullData = [];
    let state = {
        activeParam: 'oxygen',
        showLabels: false,
        horizon: '0',
        year: null 
    };

    function formatNumber(value, decimalPlaces) { if (typeof value !== 'number' || !isFinite(value)) return 'н/д'; return value.toFixed(decimalPlaces).replace('.', ','); }
    function formatFullDateTime(dateStr, timeStr) { if (!dateStr || !timeStr) return 'Нет данных'; const dateParts = String(dateStr).split('/'); const timeParts = String(timeStr).split(':'); if (dateParts.length !== 3 || timeParts.length < 2) return 'Неверный формат'; const [month, day, year] = dateParts; const [hour, minute] = timeParts; return `${String(day).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year} ${hour}:${minute}`; }
    function generateDynamicBreaks(data, prop, numSteps) { if (!data || data.length === 0) return []; const values = data.map(d => d.properties[prop]).filter(v => typeof v === 'number' && isFinite(v)); if (values.length < 2) return values.length > 0 ? [values[0], values[0]] : []; const min = Math.min(...values); const max = Math.max(...values); if (min === max) return [min, max]; const step = (max - min) / numSteps; return Array.from({length: numSteps + 1}, (_, i) => parseFloat((min + i * step).toFixed(2))); }
    function updateLegend() { const paramConfig = config.scales[state.activeParam]; if (!paramConfig) { document.getElementById('legend').innerHTML = ''; return; } let content = `<h4>${paramConfig.title}</h4>`; if (state.activeParam === 'oxygen' && paramConfig.breaks) { const breaks = paramConfig.breaks; const bands = paramConfig.bands; content += `<div><span class="legend-key" style="background-color: ${bands[0]}"></span>&lt; ${formatNumber(breaks[0], 1)} (гипоксия)</div>`; content += `<div><span class="legend-key" style="background-color: ${bands[1]}"></span>${formatNumber(breaks[0], 1)} - ${formatNumber(breaks[1], 1)}</div>`; content += `<div><span class="legend-key" style="background-color: ${bands[2]}"></span>${formatNumber(breaks[1], 1)} - ${formatNumber(breaks[2], 1)}</div>`; content += `<div><span class="legend-key" style="background-color: ${bands[3]}"></span>&ge; ${formatNumber(breaks[2], 1)}</div>`; } else { const dynamicBreaks = paramConfig.dynamicBreaks; if (!dynamicBreaks || dynamicBreaks.length < 2) { document.getElementById('legend').innerHTML = ''; return; } for (let i = 0; i < paramConfig.bands.length; i++) { if(dynamicBreaks[i+1]) { const start = formatNumber(dynamicBreaks[i], paramConfig.format); const end = formatNumber(dynamicBreaks[i+1], paramConfig.format); content += `<div><span class="legend-key" style="background-color: ${paramConfig.bands[i]}"></span>${start} - ${end}</div>`; } } } document.getElementById('legend').innerHTML = content; }
    function updateLayers() { const yearFilteredFeatures = fullData.filter(f => String(f.properties.date).split('/')[2] === state.year); const filteredFeatures = yearFilteredFeatures.filter(f => String(f.properties.horizon) === state.horizon); const filteredGeoJSON = { type: 'FeatureCollection', features: filteredFeatures }; map.getSource('points-source').setData(filteredGeoJSON); Object.keys(config.scales).forEach(param => { const paramConfig = config.scales[param]; const layerId = `${param}-points-layer`; const breaks = paramConfig.breaks || generateDynamicBreaks(filteredFeatures, paramConfig.prop, paramConfig.bands.length); paramConfig.dynamicBreaks = breaks; if (breaks.length > 1) { let colorExpression; if (paramConfig.breaks) { const colorStops = paramConfig.breaks.flatMap((breakValue, index) => [breakValue, paramConfig.bands[index + 1]]); colorExpression = ['step', ['get', paramConfig.prop], paramConfig.bands[0], ...colorStops]; } else { const colorStops = []; for (let i = 1; i < paramConfig.bands.length; i++) { colorStops.push(breaks[i], paramConfig.bands[i]); } colorExpression = ['step', ['get', paramConfig.prop], paramConfig.bands[0], ...colorStops]; } map.setPaintProperty(layerId, 'circle-color', colorExpression); map.setPaintProperty(layerId, 'circle-radius', paramConfig.sizeConfig.base); } else { map.setPaintProperty(layerId, 'circle-color', '#cccccc'); map.setPaintProperty(layerId, 'circle-radius', paramConfig.sizeConfig.base); } }); Object.keys(config.scales).forEach(param => { const is_active = param === state.activeParam; map.setLayoutProperty(`${param}-points-layer`, 'visibility', is_active ? 'visible' : 'none'); map.setLayoutProperty(`${param}-labels-layer`, 'visibility', is_active && state.showLabels ? 'visible' : 'none'); }); updateLegend(); }
    function setupControls(years) { const yearSelect = document.getElementById('year-select'); yearSelect.innerHTML = ''; years.forEach(year => { yearSelect.innerHTML += `<option value="${year}">${year}</option>`; }); yearSelect.value = state.year; yearSelect.addEventListener('change', (e) => { state.year = e.target.value; updateLayers(); }); document.querySelectorAll('.layer-group button').forEach(button => { button.addEventListener('click', (e) => { document.querySelectorAll('.layer-group button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); state.activeParam = e.target.dataset.param; updateLayers(); }); }); document.querySelectorAll('input[name="horizon"]').forEach(radio => { radio.addEventListener('change', (e) => { state.horizon = e.target.value; updateLayers(); }); }); document.getElementById('show-labels').addEventListener('change', (e) => { state.showLabels = e.target.checked; updateLayers(); }); }

    async function initializeMap() {
        try {
            console.log("Запрашиваем данные с сервера...");
            const response = await fetch('https://sea-data-api.onrender.com/api/data');

            if (!response.ok) {
                throw new Error(`Ошибка сети: ${response.status} ${response.statusText}`);
            }

            const rawData = await response.json();
            const validData = rawData.filter(p => p.longitude != null && p.latitude != null);
            console.log("Данные успешно получены:", validData);

            validData.forEach(p => {
                p.datetime_full_formatted = formatFullDateTime(p.date, p.time);
                p.oxygen_mgl_formatted = formatNumber(p.oxygen_mgl, 1);
                p.temp_c_formatted = formatNumber(p.temp_c, 1);
                p.ph_formatted = formatNumber(p.ph, 2);
                p.salinity_psu_formatted = formatNumber(p.salinity_psu, 2);
            });

            fullData = validData.map(p => ({ type: 'Feature', geometry: { type: 'Point', coordinates: [p.longitude, p.latitude] }, properties: p }));
            
            const years = [...new Set(validData.map(p => String(p.date).split('/')[2]))].sort((a, b) => b - a);
            if (years.length > 0) {
                state.year = years[0];
            }

            map.addSource('points-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

            Object.entries(config.scales).forEach(([param, scale]) => {
                map.addLayer({ id: `${param}-points-layer`, type: 'circle', source: 'points-source', layout: { visibility: 'none' }, paint: { 'circle-stroke-width': 1.5, 'circle-stroke-color': '#fff' } }, config.firstLabelLayerId);
                map.addLayer({ id: `${param}-labels-layer`, type: 'symbol', source: 'points-source', layout: { visibility: 'none', 'text-field': ['get', `${scale.prop}_formatted`], 'text-size': 11, 'text-offset': [0, 1.5], 'text-allow-overlap': true, 'text-ignore-placement': true }, paint: { 'text-color': '#000000', 'text-halo-color': '#ffffff', 'text-halo-width': 2 } }, config.firstLabelLayerId);
            });
            
            setupControls(years);

            Object.keys(config.scales).forEach(param => {
                map.on('click', `${param}-points-layer`, (e) => {
                    const props = e.features[0].properties;
                    const popupHTML = `<strong>Станция ${props.station_id}</strong><div class="popup-subheader">${props.bay}</div><div>Горизонт: ${props.horizon}</div><div>Дата: ${props.datetime_full_formatted}</div><table><tr><td>Температура:</td><td>${props.temp_c_formatted}°C</td></tr><tr><td>Солёность:</td><td>${props.salinity_psu_formatted} PSU</td></tr><tr><td>Кислород:</td><td>${props.oxygen_mgl_formatted} мг/л</td></tr><tr><td>pH:</td><td>${props.ph_formatted}</td></tr></table>`;
                    new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(popupHTML).addTo(map);
                });
                map.on('mouseenter', `${param}-points-layer`, () => map.getCanvas().style.cursor = 'pointer');
                map.on('mouseleave', `${param}-points-layer`, () => map.getCanvas().style.cursor = '');
            });

            updateLayers();

        } catch (error) {
            console.error("Не удалось загрузить данные для карты:", error);
            alert("Ошибка при загрузке данных с сервера. Пожалуйста, проверьте консоль разработчика для деталей.");
        }
    }

    map.on('load', () => {
        map.setLanguage('ru');
        initializeMap();
    });
</script>

</body>
</html>